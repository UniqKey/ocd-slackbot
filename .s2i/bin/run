#!/bin/sh

if [ -z ${PASSPHRASE+x} ]; then
    >&2 echo "ERROR no PASSPHRASE"
    sleep 1
    exit 1
fi

GPG_PRIVATE_KEY=$(find . -type f -name \*.prv.key)

if [[ "$?" -ne "0" ]]; then
    >&2 echo "ERROR could not find \*.prv.key"
    sleep 1
    exit 2
fi

echo $PASSPHRASE | gpg --import --passphrase-fd 0 $GPG_PRIVATE_KEY

if [[ "$?" -ne "0" ]]; then
    >&2 echo "ERROR could not decrypt and import $GPG_PRIVATE_KEY"
    sleep 1
    exit 3
fi

gpg --list-secret-keys

set +x

# gpg decrypt all the *secret files
find ${OCD_CHECKOUT_PATH} -type f -name '*secret' | while read -r SECRET ; do 
    if [ ! -f "${SECRET%.*}" ]; then
        echo $PASSPHRASE | gpg --no-tty --batch --passphrase-fd 0 --output "${SECRET%.*}" --decrypt "${SECRET%.*}.secret"
        if [ ! -f "${SECRET%.*}" ]; then
            >&2 echo "PANIC! Could not decrypt ${SECRET%.*}.secret. Check 'git secret whoknows' against 'gpg --list-secret-keys'"
            sleep 1
            exit 4
        fi
    fi
done

cat $HOME/.env

exec $STI_SCRIPTS_PATH/run